---
title: "BCRC Dashboard"
date: "</br>Updated: `r format(as.POSIXlt(Sys.time(), tz = 'UTC'), '%b-%d %H:%M UTC')`"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "About", href: "#about" }
      - { title: "Follow me on Twitter", href: "https://twitter.com/cnftstats"}
    social: ["menu"]
    css: rmd_flexboard.css
    self_contained: yes
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, comment = "",
                      dev = "svglite", fig.ext = ".svg")

# Libraries
library(flexdashboard)
library(htmlwidgets)
library(data.table)
library(magrittr)
library(ggplot2)
library(svglite)
library(plotly)
library(DT)

# Data
DT <- readRDS("data/DT.rds")
DTL <- readRDS("data/DTL.rds")
RAR <- readRDS("data/RAR.rds")
traits <- readRDS("data/traits.rds")

# javascript (clickable datapoints url)
# https://stackoverflow.com/questions/51681079/how-to-make-scatterplot-points-open-a-hyperlink-using-ggplotly-r

js <- "function(el, x) {
  el.on('plotly_click', function(d) {
    var link = d.points[0].customdata;
    window.open(link);
  });
}"


# Functions
loj <- function (X = NULL, Y = NULL, onCol = NULL) {
  if (truelength(X) == 0 | truelength(Y) == 0) 
    stop("setDT(X) and setDT(Y) first")
  n <- names(Y)
  X[Y, `:=`((n), mget(paste0("i.", n))), on = onCol]
}
```

# Rank {data-icon="fa-signal"}
## Column 1 {data-width=500, .tabset}
### Linear scale
```{r}
X <- DT[price < 6000]
scale_x <- c(seq(0, 2000, 250), seq(2500, 10000, 500))
scale_x[scale_x == 0] <- 1
scale_x[scale_x == 10000] <- 9999
scale_y <- c(seq(0, 2000, 250), seq(2000, 6000, 500))
gg <- ggplot(X, aes(asset_rank, price, shape = sc, customdata = link,
                    text = paste0(asset,
                                  "</br></br>", paste("Price:", price,
                                                      "</br>Last offer:", last_offer,
                                                      "</br>Rank:", asset_rank,
                                                      "</br>Rarity:", asset_rarity,
                                                      "</br>Market:", market,
                                                      "</br>Sc:", sc)))) +
  geom_point(color = "steelblue4", alpha = .6) +
  scale_x_reverse(breaks = scale_x, expand = c(0.03, 0)) +
  scale_y_continuous(breaks = scale_y) +
  labs(x = "Rank", y = "Listing price", color = "Market", shape = "Smart contract") +
  theme(legend.title = element_text(size = 10))

ggplotly(gg, tooltip = "text") %>% 
  layout(legend = list(x = .025, y = .97, bgcolor = 'rgba(255,255,255,0.6)'),
         xaxis = list(tickangle = 45)) %>%
  onRender(js)
```

> Only listings below 6000 ada are displayed. Try click on the legend or datapoints.

### Log scale
```{r}
X <- DT[price < 6000]
scale_x <- c(seq(0, 2000, 250), seq(2500, 10000, 500))
scale_x[scale_x == 0] <- 1
scale_x[scale_x == 10000] <- 9999
scale_y <- c(seq(0, 250, 25), seq(250, 500, 50), seq(500, 2000, 250), seq(2000, 6000, 500))

gg <- ggplot(X, aes(asset_rank, price, shape = sc, customdata = link,
                    text = paste0(asset,
                                  "</br></br>", paste("Price:", price,
                                                      "</br>Last offer:", last_offer,
                                                      "</br>Rank:", asset_rank,
                                                      "</br>Rarity:", asset_rarity,
                                                      "</br>Market:", market,
                                                      "</br>Sc:", sc)))) +
  geom_point(color = "steelblue4", alpha = .6) +
  scale_x_reverse(breaks = scale_x, expand = c(0.03, 0)) +
  scale_y_continuous(breaks = scale_y, trans = "log2") +
  labs(x = "Rank", y = "Listing price (log)", color = "Market", shape = "Smart contract") +
  theme(legend.title = element_text(size = 10))

ggplotly(gg, tooltip = "text") %>% 
  layout(legend = list(x = .025, y = .97, bgcolor = 'rgba(255,255,255,0.6)'),
         xaxis = list(tickangle = 45)) %>%
  onRender(js)
```

> Only listings below 6000 ada are displayed. Try click on the legend or datapoints.

## Column 2 {data-width=500, .tabset}
### Cheapest listings by rank range
```{r}
X <- DT[, .SD[price == min(price)], rank_range][order(rank_range)]
X[, img := sprintf('<img src="img/BCRC%s.png" class="img_html">', asset_number)]
X[, img := sprintf('<a href="%s" target="_blank">%s</br>#%s</a>', link, img, asset_number)]

X <- X[, .(rank_range, img, price, asset_rank, asset_rarity, sc, market, asset_traits_num, asset_traits)]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Rank</br>range", "Asset", "Price", "Rank", "Rarity", "Sc", "Market",
                       "Num.</br>traits", "Traits"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

> Tip: Click on the image to be open the listing.

### Listings stats by rank range
```{r}
X <- DT[, .(num_assets = .N,
            min_price = min(price),
            quant_05_price = quantile(price, probs = .05, names = FALSE),
            quant_10_price = quantile(price, probs = .10, names = FALSE),
            quant_25_price = quantile(price, probs = .25, names = FALSE),
            quant_50_price = quantile(price, probs = .50, names = FALSE),
            quant_75_price = quantile(price, probs = .75, names = FALSE),
            quant_90_price = quantile(price, probs = .90, names = FALSE),
            quant_95_price = quantile(price, probs = .95, names = FALSE),
            max_price = max(price)), rank_range][order(rank_range)]

.cols <- names(X)[!(names(X) %like% "_range")]
X[, (.cols) := lapply(.SD, function(x) sprintf("%.f", x)), .SDcols = .cols]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Stats</br>range", "Num.</br>offers", "Min.</br>price",
                       "Price</br>Q5%", "Price</br>Q10%", "Price</br>Q25%", "Price</br>Q50%",
                       "Price</br>Q75%", "Price</br>Q90%", "Price</br>Q95%", "Max.</br>price"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

> `Q` = Quantiles. For instance, `Q05%` means that only 5% of the listings prices are equal or below that price.

# Rarity {data-icon="ion-star"}
## Column 1 {data-width=500, .tabset}
### Linear scale
```{r}
X <- DT[price < 6000]
scale_x <- seq(70, 320, 10)
scale_y <- c(seq(0, 2000, 250), seq(2000, 6000, 500))
gg <- ggplot(X, aes(asset_rarity, price, shape = sc, customdata = link,
                    text = paste0(asset,
                                  "</br></br>", paste("Price:", price,
                                                      "</br>Last offer:", last_offer,
                                                      "</br>Rank:", asset_rank,
                                                      "</br>Rarity:", asset_rarity,
                                                      "</br>Market:", market,
                                                      "</br>Sc:", sc)))) +
  geom_point(color = "steelblue4", alpha = .6) +
  scale_x_continuous(breaks = scale_x, expand = c(0.03, 0)) +
  scale_y_continuous(breaks = scale_y) +
  labs(x = "Rarity", y = "Listing price", color = "Market", shape = "Smart contract") +
  theme(legend.title = element_text(size = 10))

ggplotly(gg, tooltip = "text") %>% 
  layout(legend = list(x = .025, y = .97, bgcolor = 'rgba(255,255,255,0.6)'),
         xaxis = list(tickangle = 45)) %>%
  onRender(js)
```

> Only listings below 6000 ada are displayed. Try click on the legend or datapoints.

### Log scale
```{r}
X <- DT[price < 6000]
scale_x <- seq(70, 320, 10)
scale_y <- c(seq(0, 250, 25), seq(250, 500, 50), seq(500, 2000, 250), seq(2000, 6000, 500))
gg <- ggplot(X, aes(asset_rarity, price, shape = sc, customdata = link,
                    text = paste0(asset,
                                  "</br></br>", paste("Price:", price,
                                                      "</br>Last offer:", last_offer,
                                                      "</br>Rank:", asset_rank,
                                                      "</br>Rarity:", asset_rarity,
                                                      "</br>Market:", market,
                                                      "</br>Sc:", sc)))) +
  geom_point(color = "steelblue4", alpha = .6) +
  scale_x_continuous(breaks = scale_x, expand = c(0.03, 0)) +
  scale_y_continuous(breaks = scale_y, trans = "log2") +
  labs(x = "Rarity", y = "Listing price (log)", color = "Market", shape = "Smart contract") +
  theme(legend.title = element_text(size = 10))

ggplotly(gg, tooltip = "text") %>% 
  layout(legend = list(x = .025, y = .97, bgcolor = 'rgba(255,255,255,0.6)'),
         xaxis = list(tickangle = 45)) %>%
  onRender(js)
```

> Only listings below 6000 ada are displayed. Try click on the legend or datapoints.

## Column 2 {data-width=500, .tabset}
### Cheapest listings by rarity range
```{r}
X <- DT[, .SD[price == min(price)], rarity_range][order(-rarity_range)]
X[, img := sprintf('<img src="img/BCRC%s.png" class="img_html">', asset_number)]
X[, img := sprintf('<a href="%s" target="_blank">%s</br>#%s</a>', link, img, asset_number)]

X <- X[, .(rarity_range, img, price, asset_rank, asset_rarity, sc, market, asset_traits_num, asset_traits)]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Rarity</br>range", "Asset", "Price", "Rank" , "Rarity", "Sc", "Market",
                       "Num.</br>traits", "Traits"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

> Tip: Click on the image to be open the listing.

### Listings stats by rarity range
```{r}
X <- DT[, .(num_assets = .N,
            min_price = min(price),
            quant_05_price = quantile(price, probs = .05, names = FALSE),
            quant_10_price = quantile(price, probs = .10, names = FALSE),
            quant_25_price = quantile(price, probs = .25, names = FALSE),
            quant_50_price = quantile(price, probs = .50, names = FALSE),
            quant_75_price = quantile(price, probs = .75, names = FALSE),
            quant_90_price = quantile(price, probs = .90, names = FALSE),
            quant_95_price = quantile(price, probs = .95, names = FALSE),
            max_price = max(price)), rarity_range][order(-rarity_range)]

.cols <- names(X)[!(names(X) %like% "_range")]
X[, (.cols) := lapply(.SD, function(x) sprintf("%.f", x)), .SDcols = .cols]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Rarity</br>range", "Num.</br>offers", "Min.</br>price",
                       "Price</br>Q5%", "Price</br>Q10%", "Price</br>Q25%", "Price</br>Q50%",
                       "Price</br>Q75%", "Price</br>Q90%", "Price</br>Q95%", "Max.</br>price"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

> `Q` = Quantiles. For instance, `Q05%` means that only 5% of the listings prices are equal or below that price.

# Traits {data-icon="ion-android-color-palette"}
## Column 1 {data-width=400, .tabset}
### Cheapest listings by trait
```{r}
X <- DTL[, .SD[price == min(price)], trait][order(trait)]
X[, img := asset_number]
X[, img := sprintf(
  '<img src="img/BCRC%s.png" class="img_html">', img
)]
X[, img := sprintf('<a href="%s" target="_blank">%s</br>#%s</a>', link, img, asset_number)]

X <- X[, .(trait_category, trait, img, price, asset_rank, asset_rarity,
           sc, market, asset_traits_num, asset_traits)]

X <- X[order(trait_category, trait)]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Trait</br>category", "Trait", "Asset", "Price", "Rank",  "Rarity", "Sc", "Market",
                       "Num.</br>traits", "Traits"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

### Listings stats by trait
```{r}
X <- DTL[, .(num_assets = .N,
             min_rank = min(asset_rank),
             min_rarity = min(asset_rarity),
             min_price = min(price),
             quant_05_price = quantile(price, probs = .05, names = FALSE),
             quant_10_price = quantile(price, probs = .10, names = FALSE),
             quant_25_price = quantile(price, probs = .25, names = FALSE),
             quant_50_price = quantile(price, probs = .50, names = FALSE),
             quant_75_price = quantile(price, probs = .75, names = FALSE),
             quant_90_price = quantile(price, probs = .90, names = FALSE),
             quant_95_price = quantile(price, probs = .95, names = FALSE),
             max_price = max(price)), .(trait_category, trait)][order(trait_category, trait)]

.cols <- names(X)[!(names(X) %like% "trait")]
X[, (.cols) := lapply(.SD, function(x) sprintf("%.f", x)), .SDcols = .cols]
X <- X[complete.cases(X)]

datatable(X, class = 'dt-right compact stripe hover',
          options = list(pageLength = 100,
                         scrollY = '100%',
                         bLengthChange = FALSE,
                         bPaginate = FALSE,
                         info = FALSE),
          colnames = c("Trait</br>category", "Trait", "Num.</br>offers", 
                       "Min.</br>rank", "Min.</br>rarity", "Min.</br>price",
                       "Price</br>Q5%", "Price</br>Q10%", "Price</br>Q25%", "Price</br>Q50%",
                       "Price</br>Q75%", "Price</br>Q90%", "Price</br>Q95%", "Max.</br>price"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

# My NFT rank/rarity {data-icon="ion-help-circled"}
## Column 1
### Find your NFT rank and rarity
```{r}
# ion-information-circled
X <- RAR[, .(asset_name = paste0("Boss Cat Rocket Club #", asset_number), asset_rank, asset_rarity)]
datatable(X, class = 'dt-right compact stripe hover',
          options = list(
            pageLength = 30,
            scrollY = '100%',
            bLengthChange = FALSE,
            bPaginate = TRUE,
            info = TRUE,
            autoWidth = TRUE,
            columnDefs = list(list(width = '100px', targets = c(1, 3)))),
          colnames = c("Asset", "Rank", "Rarity"),
          rownames = FALSE,
          escape = FALSE) %>%
  formatStyle(columns = 1:ncol(X), fontSize = '90%')
```

> Use the search box to look for your BCRC. For example, search `#3000`.

# Buy me a coffee {data-icon="ion-coffee"}
## Column 1
### Thanks for your support!
Any tips would be greatly appreciated! This will also help me to improve the website (for instance, to get a better hosting service).  

![Tip me](tipme.png)  
**addr1qx04gwr9kazlpnm6t8a8h0pggk440zs3fdayct732a0wwwd3usryhnh52pevj5xy7cgp9d4jnywar6g0tnct58dyfukszl25n8**

You can also support me by spreading the word about this website to the CNFT community! :-)  

# about {.hidden}
## Columun 1
### About the website
#### The data
- Listings data is comes from <a href="https://cnft.io/" target="_blank">cnft.io</a> and <a href="https://www.jpg.store/" target="_blank">jpg.store</a> marketplaces.
- Rank and rarity scores come from from <a href="https://bosscatrocketclub.com/" target="_blank">bosscatrocketclub.com</a>.
- The website is updated every ~20mins. This will be improved in the future. You need to hit `F5` to manually see the updates on the website.

#### Comming soon
- Only the *listings* are currently analyzed, but the *sales* will be soon included.

#### Disclaimer
- This is an early version, so there might be some bugs! Use at your own risk.

## Columun 2
### Resources
- <a href="https://bosscatrocketclub.com/" target="_blank">Boss Cat Rocket Club official website/ranking</a>.
- Is rarity the same as rank? No. As you can see from the figure below, the relation between rank and rarity is quite stable below rank 1000, then rarity drastically increases above rank ~1000.  
```{r fig.height=4, fig.width=4, fig.align='left'}
ggplot(RAR, aes(asset_rank, asset_rarity)) +
  geom_line(color = "steelblue4", alpha = .6, size = 1) +
  scale_x_reverse() +
  scale_y_continuous() +
  labs(x = "Rank", y = "Rarity")
```

## Column 3
### Changelog
#### Version 1.0
- This is the first version of this website! More to come soon.

### About me
- I am passionate about crypto, (c)nfts, stats, and programming!
- Hit me on discord: <a href="https://discord.com/users/K2#8332/" target="_blank">K2#8332</a>
- Follow me on Twitter: <a href="https://twitter.com/cnftstats" target="_blank">@cnftstats</a>
